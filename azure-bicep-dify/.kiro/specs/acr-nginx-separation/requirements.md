# 要件ドキュメント

## 概要

この機能は、Azure Container Registry (ACR) とカスタムnginxコンテナのデプロイを、メインのBicepインフラストラクチャテンプレートから分離します。目的は、3段階のデプロイワークフローを確立することです：(1) ACRインフラストラクチャのデプロイ、(2) nginxコンテナのビルドとプッシュ、(3) メインインフラストラクチャのデプロイ。この分離により、デプロイシーケンスをより適切に制御でき、Container Appsがデプロイされる前にnginxコンテナを利用可能にすることができます。

## 用語集

- **ACR**: Azure Container Registry - Azureのマネージドコンテナレジストリサービス
- **メインBicepテンプレート**: すべてのインフラストラクチャコンポーネントをデプロイする既存のmain.bicepファイル
- **ACR Bicepテンプレート**: ACRリソースのみをデプロイする新しいスタンドアロンBicepテンプレート
- **nginxコンテナ**: Difyコンポーネントへのトラフィックをルーティングするカスタムnginx Dockerコンテナ
- **デプロイスクリプト**: インフラストラクチャのデプロイを調整するbashスクリプト (deploy.sh)
- **ビルドスクリプト**: nginxコンテナをビルドしてプッシュするbashスクリプト (build-and-push-nginx.sh)

## 要件

### 要件1

**ユーザーストーリー:** DevOpsエンジニアとして、メインインフラストラクチャとは独立してACRをデプロイしたい。そうすることで、Container Appsをデプロイする前にコンテナイメージをプッシュできる

#### 受け入れ基準

1. システムは、ACRリソースのみをデプロイする新しいBicepテンプレートファイルを'bicep/acr-only.bicep'に作成しなければならない
2. ACR Bicepテンプレートは、environment、location、tagsをパラメータとして受け入れなければならない
3. ACR Bicepテンプレートは、ACR名とログインサーバーURLを出力しなければならない
4. ACR Bicepテンプレートは、一貫性を確保するためにメインテンプレートと同じACRモジュールを使用しなければならない
5. メインBicepテンプレートは、ACRモジュールのデプロイを削除し、ACR名を入力パラメータとして受け入れなければならない

### 要件2

**ユーザーストーリー:** DevOpsエンジニアとして、3段階のデプロイを調整するデプロイスクリプトが欲しい。そうすることで、リソースが正しい順序でデプロイされる

#### 受け入れ基準

1. デプロイスクリプトは、フェーズ1でACR Bicepテンプレートをデプロイしなければならない
2. ACRデプロイが完了したとき、デプロイスクリプトはnginxコンテナのビルドとプッシュスクリプトを実行しなければならない
3. nginxコンテナのプッシュが完了したとき、デプロイスクリプトはACR名とnginxイメージURLをパラメータとしてメインBicepテンプレートをデプロイしなければならない
4. デプロイスクリプトは、次のフェーズに進む前に各フェーズが正常に完了したことを検証しなければならない
5. いずれかのフェーズが失敗した場合、デプロイスクリプトは実行を停止し、エラーメッセージを表示しなければならない

### 要件3

**ユーザーストーリー:** DevOpsエンジニアとして、メインBicepテンプレートがnginxイメージURLをパラメータとして受け入れるようにしたい。そうすることで、ACRからカスタムnginxコンテナを使用できる

#### 受け入れ基準

1. メインBicepテンプレートは、デフォルト値を持つnginxImageパラメータを受け入れなければならない
2. メインBicepテンプレートは、nginxImageパラメータをnginx Container Appモジュールに渡さなければならない
3. メインBicepテンプレートは、ACRデプロイロジックを含んではならない
4. メインBicepテンプレートは、参照目的でacrNameをオプションパラメータとして受け入れなければならない
5. メインBicepテンプレートは、既存のパラメータファイルとの後方互換性を維持しなければならない

### 要件4

**ユーザーストーリー:** DevOpsエンジニアとして、新しいデプロイ構造を反映した更新されたパラメータファイルが欲しい。そうすることで、デプロイが正しい設定を使用する

#### 受け入れ基準

1. システムは、ACR関連のパラメータが存在する場合、パラメータファイルから削除しなければならない
2. システムは、ACRベースのイメージURLを持つnginxImageパラメータをパラメータファイルに追加しなければならない
3. パラメータファイルは、既存のACR以外のすべてのパラメータを維持しなければならない
4. パラメータファイルは、デプロイ中に置き換えることができるプレースホルダー値を使用しなければならない
5. システムは、どの値が自動入力されるかを示す明確なコメントをパラメータファイルに提供しなければならない

### 要件5

**ユーザーストーリー:** DevOpsエンジニアとして、ビルドとプッシュスクリプトが新しいデプロイフローで動作するようにしたい。そうすることで、nginxコンテナが正しいACRにプッシュされる

#### 受け入れ基準

1. ビルドスクリプトは、ACR名をパラメータとして受け入れなければならない
2. ビルドスクリプトは、イメージをプッシュする前にACRに認証しなければならない
3. ビルドスクリプトは、docker/nginxディレクトリからnginx Dockerイメージをビルドしなければならない
4. ビルドスクリプトは、ACRログインサーバーURLでイメージにタグを付けなければならない
5. ビルドスクリプトは、後続のデプロイフェーズで使用するために完全なイメージURLを出力しなければならない
