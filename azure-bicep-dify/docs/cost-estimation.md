# Dify on Azure - コスト試算

## 概要

このドキュメントは、Dify on Azure構成の月額コスト試算を示します。試算は**東日本（Japan East）リージョン**を基準とし、2024-2025年のAzure料金に基づいています。

**注意**:
- 実際のコストは使用量、リージョン、契約形態により変動します
- この試算は参考値であり、正確な見積もりはAzure料金計算ツールをご利用ください
- 為替レートは1 USD = 150 JPYで計算しています

## コスト試算サマリー

| 環境 | 構成 | 月額コスト（税抜） | 主要コスト |
|-----|------|-----------------|----------|
| **開発環境** | 時間ベース(平日9-18時) | **¥33,114**（Registry除く）<br>**¥33,864**（Registry含む） | Application Gateway (40%)、Container Apps (20%)、Private Endpoint (15%) |
| **本番環境** | HA構成 | 約 **¥220,000 - ¥280,000** | Application Gateway (41%)、PostgreSQL (18%)、監視・ログ (17%) |

## 開発環境の詳細コスト試算

### 1. Application Gateway Standard_v2

**注**: 開発環境ではコスト最適化のため、WAF機能なしのStandard_v2 SKUを使用します。

| 項目 | 数量/設定 | 単価 | 月額コスト |
|-----|---------|------|----------|
| 固定料金 | 1ユニット | ¥3,000/ユニット/月 | ¥3,000 |
| キャパシティユニット | 平均1.5ユニット | ¥840/CU/月 | ¥1,260 |
| データ処理 | 100 GB/月 | ¥90/GB | ¥9,000 |
| **小計** | - | - | **¥13,260** |

**想定**:
- SKU: Standard_v2（WAF機能なし）
- 最小キャパシティ: 1ユニット
- 平均キャパシティ: 1.5ユニット（軽負荷）
- データ処理量: 月100GB（約3GB/日）

**WAF_v2との比較**:
- 固定料金: ¥4,560 → ¥3,000（-34%）
- CU単価: ¥1,260 → ¥840（-33%）
- データ処理: ¥147/GB → ¥90/GB（-39%）
- **月額削減: ¥7,890（-37%）**

### 2. Azure Container Apps

#### Container Apps Environment（Consumption）

**時間ベーススケーリング構成（Azure Automation、平日9時間稼働）**

| 項目 | 数量/設定 | 単価 | 月額コスト |
|-----|---------|------|----------|
| vCPU使用量 | 2 vCPU × 9時間/日 × 22営業日 | ¥1.38/vCPU/時 | ¥5,464 |
| メモリ使用量 | 4 GiB × 9時間/日 × 22営業日 | ¥0.153/GiB/時 | ¥1,211 |
| リクエスト数 | 1,000,000リクエスト/月 | ¥0.60/100万リクエスト | ¥0.6 |
| **小計** | - | - | **¥6,676** |

**リソース構成**:
- dify-web: 0.5 vCPU, 1 GiB、最小レプリカ0-1（時間ベース）
- dify-api: 1.0 vCPU, 2 GiB、最小レプリカ0-1（時間ベース）
- dify-worker: 0.5 vCPU, 1 GiB、最小レプリカ0-1（時間ベース）

**スケジュール設定**:
- 平日9:00-18:00（9時間）: 最小レプリカ1（即座に応答、コールドスタートなし）
- 平日18:00-翌9:00、土日祝日: 最小レプリカ0（完全停止、コスト0）
- 営業日: 22日/月
- Azure Automationコスト: ¥0（無料枠内）

**時間ベーススケーリングの動作**:
- **9:00 JST**: Azure Automation Runbookが最小レプリカを1に設定
- **業務時間中**: 常時1台稼働、コールドスタートなし、即座に応答
- **18:00 JST**: Azure Automation Runbookが最小レプリカを0に設定
- **夜間・週末**: 完全停止（アクセスがあれば5-30秒で起動）

**コスト削減効果**:
- 夜間・週末の完全停止により大幅なコスト削減
- 業務時間中はパフォーマンス維持（コールドスタートなし）

### 3. Azure Database for PostgreSQL Flexible Server

| 項目 | SKU | 単価 | 月額コスト |
|-----|-----|------|----------|
| コンピューティング | Burstable B1ms (1 vCore, 2 GiB) | ¥1,155/月 | ¥1,155 |
| ストレージ | 32 GiB | ¥1,785/32GiB/月 | ¥1,785 |
| バックアップストレージ | 32 GiB (無料枠内) | ¥0 | ¥0 |
| **小計** | - | - | **¥2,940** |

**想定**:
- Burstable tier（コスト最適化）
- ストレージ: 32 GiB
- バックアップ保持: 7日（ストレージサイズと同容量まで無料）

### 4. Azure Cache for Redis

| 項目 | SKU | 単価 | 月額コスト |
|-----|-----|------|----------|
| Basic C1 | 1 GB キャッシュ | ¥2,820/月 | ¥2,820 |
| **小計** | - | - | **¥2,820** |

**想定**:
- Basic C1（1 GB）
- レプリケーションなし
- 永続化なし

### 5. Azure Blob Storage

| 項目 | 数量/設定 | 単価 | 月額コスト |
|-----|---------|------|----------|
| LRS ストレージ（Hot） | 50 GB | ¥2.835/GB/月 | ¥142 |
| トランザクション | 100,000トランザクション | ¥0.0672/10,000 | ¥0.67 |
| データ取得 | 10 GB | ¥0.015/GB | ¥0.15 |
| **小計** | - | - | **¥143** |

**想定**:
- LRS（ローカル冗長ストレージ）
- Hotアクセス層
- 月50GB

### 6. Azure Key Vault

| 項目 | 数量/設定 | 単価 | 月額コスト |
|-----|---------|------|----------|
| シークレット操作 | 10,000操作 | ¥0.045/10,000操作 | ¥0.45 |
| 証明書更新 | 1回/月 | ¥450/更新 | ¥450 |
| **小計** | - | - | **¥450** |

### 7. Virtual Network関連

| 項目 | 数量/設定 | 単価 | 月額コスト |
|-----|---------|------|----------|
| VNet | 1個 | ¥0（無料） | ¥0 |
| NSG | 3個 | ¥0（無料） | ¥0 |
| Private Endpoint | 4個 | ¥1,125/endpoint/月 | ¥4,500 |
| Private Endpoint データ処理 | 50 GB/月 | ¥1.5/GB | ¥75 |
| Private DNS Zone | 4ゾーン | ¥75/ゾーン/月 | ¥300 |
| **小計** | - | - | **¥4,875** |

### 8. パブリックIPアドレス

| 項目 | 数量/設定 | 単価 | 月額コスト |
|-----|---------|------|----------|
| Standard Static IP | 1個 | ¥450/月 | ¥450 |
| **小計** | - | - | **¥450** |

### 9. 監視・ログ

| 項目 | 数量/設定 | 単価 | 月額コスト |
|-----|---------|------|----------|
| Log Analytics Workspace | 5 GB/月 | ¥420/GB/月（5GB以降） | ¥0（無料枠内） |
| Application Insights | 5 GB/月 | ¥420/GB/月（5GB以降） | ¥0（無料枠内） |
| NSG Flow Logs | 10 GB/月 | ¥150/GB/月 | ¥1,500 |
| **小計** | - | - | **¥1,500** |

**想定**:
- Log Analytics: 最初の5GBは無料
- Application Insights: 最初の5GBは無料

### 10. オプション: Container Registry

| 項目 | SKU | 単価 | 月額コスト |
|-----|-----|------|----------|
| Basic | 10 GBストレージ込み | ¥750/月 | ¥750 |
| **小計** | - | - | **¥750** |

---

### 開発環境 月額合計

**時間ベーススケーリング構成（Azure Automation、平日9:00-18:00稼働）**

| カテゴリ | 月額コスト |
|---------|----------|
| Application Gateway (Standard_v2) | ¥13,260 (40%) |
| Container Apps（時間ベース） | ¥6,676 (20%) |
| Private Endpoint & Network | ¥4,875 (15%) |
| PostgreSQL (Burstable B1ms) | ¥2,940 (9%) |
| Redis (Basic C1) | ¥2,820 (8%) |
| 監視・ログ | ¥1,500 (4%) |
| Key Vault | ¥450 (1%) |
| Public IP | ¥450 (1%) |
| Blob Storage | ¥143 (0.4%) |
| Azure Automation | ¥0 (無料枠内) |
| Container Registry（オプション） | ¥750 (2%) |
| **合計（Registry除く）** | **¥33,114** |
| **合計（Registry含む）** | **¥33,864** |

**コスト削減実績**:
- WAF_v2からStandard_v2への変更: **-¥7,890/月（-37%）**
- 時間ベーススケーリング採用: **-¥5,464/月（-45%）**
- **合計削減額: ¥13,354/月（-28%削減）**
- **参考（WAF_v2 + 12時間稼働）**: ¥47,218/月 → **¥33,864/月**

**注**: Standard_v2はWAF機能がありませんが、NSGとPrivate Endpointで基本的なセキュリティは確保されています。本番環境ではWAF_v2の使用を推奨します。

---

## 本番環境の詳細コスト試算

### 1. Application Gateway WAF_v2 (HA構成)

| 項目 | 数量/設定 | 単価 | 月額コスト |
|-----|---------|------|----------|
| 固定料金 | 2ユニット（Zone Redundancy） | ¥4,560/ユニット/月 | ¥9,120 |
| キャパシティユニット | 平均5ユニット | ¥1,260/CU/月 | ¥6,300 |
| データ処理 | 500 GB/月 | ¥147/GB | ¥73,500 |
| **小計** | - | - | **¥88,920** |

**想定**:
- 最小キャパシティ: 2ユニット（HA構成）
- 平均キャパシティ: 5ユニット
- データ処理量: 月500GB（約16GB/日）
- ゾーン冗長: 有効

### 2. Azure Container Apps (Dedicated)

#### Container Apps Environment（Dedicated Plan）

| 項目 | 数量/設定 | 単価 | 月額コスト |
|-----|---------|------|----------|
| D4 Dedicated Plan | 4 vCPU, 16 GiB | ¥21,000/月（概算） | ¥21,000 |
| vCPU追加使用量 | 2 vCPU × 720時間 | ¥1.38/vCPU/時 | ¥1,987 |
| メモリ追加使用量 | 4 GiB × 720時間 | ¥0.153/GiB/時 | ¥441 |
| リクエスト数 | 10,000,000リクエスト/月 | ¥0.60/100万リクエスト | ¥6 |
| **小計** | - | - | **¥23,434** |

**想定**:
- Dedicated Planで基礎リソース確保
- dify-web: 1.0 vCPU, 2 GiB、最小レプリカ2
- dify-api: 2.0 vCPU, 4 GiB、最小レプリカ2
- dify-worker: 1.0 vCPU, 2 GiB、最小レプリカ1
- 24時間稼働

### 3. Azure Database for PostgreSQL Flexible Server (HA構成)

| 項目 | SKU | 単価 | 月額コスト |
|-----|-----|------|----------|
| コンピューティング | General Purpose D2s_v3 (2 vCore, 8 GiB) HA | ¥32,400/月 | ¥32,400 |
| ストレージ | 128 GiB | ¥7,140/128GiB/月 | ¥7,140 |
| バックアップストレージ | 128 GiB（無料枠） + 64 GiB | ¥0.18/GB/月 × 64 | ¥11.52 |
| **小計** | - | - | **¥39,552** |

**想定**:
- General Purpose tier
- Zone-Redundant HA構成（2倍コスト）
- ストレージ: 128 GiB
- バックアップ保持: 14日

### 4. Azure Cache for Redis (HA構成)

| 項目 | SKU | 単価 | 月額コスト |
|-----|-----|------|----------|
| Standard C2 | 2.5 GB キャッシュ、レプリケーション | ¥14,250/月 | ¥14,250 |
| **小計** | - | - | **¥14,250** |

**想定**:
- Standard C2（2.5 GB）
- レプリケーション有効
- RDB永続化有効

### 5. Azure Blob Storage (ZRS)

| 項目 | 数量/設定 | 単価 | 月額コスト |
|-----|---------|------|----------|
| ZRS ストレージ（Hot） | 500 GB | ¥3.57/GB/月 | ¥1,785 |
| トランザクション | 1,000,000トランザクション | ¥0.0672/10,000 | ¥6.72 |
| データ取得 | 100 GB | ¥0.015/GB | ¥1.5 |
| **小計** | - | - | **¥1,793** |

**想定**:
- ZRS（ゾーン冗長ストレージ）
- Hotアクセス層
- 月500GB

### 6. Azure Key Vault

| 項目 | 数量/設定 | 単価 | 月額コスト |
|-----|---------|------|----------|
| シークレット操作 | 100,000操作 | ¥0.045/10,000操作 | ¥0.45 |
| 証明書更新 | 1回/月 | ¥450/更新 | ¥450 |
| **小計** | - | - | **¥450** |

### 7. Virtual Network関連

| 項目 | 数量/設定 | 単価 | 月額コスト |
|-----|---------|------|----------|
| VNet | 1個 | ¥0（無料） | ¥0 |
| NSG | 3個 | ¥0（無料） | ¥0 |
| Private Endpoint | 4個 | ¥1,125/endpoint/月 | ¥4,500 |
| Private Endpoint データ処理 | 200 GB/月 | ¥1.5/GB | ¥300 |
| Private DNS Zone | 4ゾーン | ¥75/ゾーン/月 | ¥300 |
| **小計** | - | - | **¥5,100** |

### 8. パブリックIPアドレス

| 項目 | 数量/設定 | 単価 | 月額コスト |
|-----|---------|------|----------|
| Standard Static IP | 1個 | ¥450/月 | ¥450 |
| **小計** | - | - | **¥450** |

### 9. 監視・ログ

| 項目 | 数量/設定 | 単価 | 月額コスト |
|-----|---------|------|----------|
| Log Analytics Workspace | 50 GB/月 | ¥420/GB/月（5GB以降） | ¥18,900 |
| Application Insights | 30 GB/月 | ¥420/GB/月（5GB以降） | ¥10,500 |
| NSG Flow Logs | 50 GB/月 | ¥150/GB/月 | ¥7,500 |
| **小計** | - | - | **¥36,900** |

### 10. Container Registry (Premium)

| 項目 | SKU | 単価 | 月額コスト |
|-----|-----|------|----------|
| Premium | 500 GBストレージ込み | ¥7,500/月 | ¥7,500 |
| **小計** | - | - | **¥7,500** |

---

### 本番環境 月額合計

| カテゴリ | 月額コスト |
|---------|----------|
| Application Gateway | ¥88,920 (41%) |
| Container Apps | ¥23,434 (11%) |
| PostgreSQL | ¥39,552 (18%) |
| Redis | ¥14,250 (7%) |
| Blob Storage | ¥1,793 (0.8%) |
| Key Vault | ¥450 (0.2%) |
| Network (PE, DNS, IP) | ¥5,550 (3%) |
| 監視・ログ | ¥36,900 (17%) |
| Container Registry | ¥7,500 (3%) |
| **合計** | **¥218,349** |

---

## スケール時の変動コスト

### Application Gatewayのスケール

#### Standard_v2（開発環境）

| シナリオ | 平均キャパシティ | データ処理 | 月額コスト | 差分 |
|---------|---------------|----------|----------|------|
| 軽負荷 | 1.5 CU | 100 GB/月 | ¥13,260 | 基準 |
| 中負荷 | 5 CU | 500 GB/月 | ¥51,000 | +¥37,740 |
| 高負荷 | 10 CU | 1 TB/月 | ¥101,400 | +¥88,140 |

#### WAF_v2（本番環境）

| シナリオ | 平均キャパシティ | データ処理 | 月額コスト | 差分 |
|---------|---------------|----------|----------|------|
| 軽負荷 | 1.5 CU | 100 GB/月 | ¥21,150 | 基準 |
| 中負荷 | 5 CU | 500 GB/月 | ¥88,920 | +¥67,770 |
| 高負荷 | 10 CU | 1 TB/月 | ¥168,570 | +¥147,420 |

### Container Appsのスケール

**開発環境（時間ベーススケーリング）:**

| シナリオ | 稼働時間 | vCPU合計 | メモリ合計 | 月額コスト |
|---------|---------|---------|----------|----------|
| **基準（9時間/営業日）** | 平日9-18時 | 2 vCPU | 4 GiB | ¥6,676 |
| 延長（12時間/営業日） | 平日8-20時 | 2 vCPU | 4 GiB | ¥8,900 |
| 24時間稼働 | 平日24時間 | 2 vCPU | 4 GiB | ¥17,800 |

**本番環境（常時稼働）:**

| シナリオ | レプリカ数 | vCPU合計 | メモリ合計 | 月額コスト |
|---------|----------|---------|----------|----------|
| 最小 | 2-3 | 4-6 vCPU | 8-12 GiB | ¥23,000 |
| 中規模 | 5-8 | 10-16 vCPU | 20-32 GiB | ¥40,000 |
| 大規模 | 10-15 | 20-30 vCPU | 40-60 GiB | ¥70,000 |

### データベーススケール

| PostgreSQL SKU | vCore | メモリ | 月額コスト | 差分 |
|---------------|-------|--------|----------|------|
| Burstable B1ms | 1 | 2 GiB | ¥1,155 | 基準 |
| GP D2s_v3 | 2 | 8 GiB | ¥16,200 | +¥15,045 |
| GP D2s_v3 (HA) | 2 | 8 GiB | ¥32,400 | +¥31,245 |
| GP D4s_v3 (HA) | 4 | 16 GiB | ¥64,800 | +¥63,645 |

---

## コスト最適化の推奨事項

### 1. Application Gatewayの最適化

**開発環境:**
- ✅ **採用済み**: Standard_v2を使用（WAF_v2比で月額¥7,890削減、-37%）
- データ処理量の監視と最適化
- 最小キャパシティ1ユニットで運用

**本番環境:**
- WAF_v2を使用（セキュリティ最優先、OWASP攻撃防御）
- データ処理量の最適化（キャッシュ活用）
- カスタムルールの精査（不要なルールを無効化）
- Reserved Capacityで長期契約割引（検討中）

### 2. Container Appsの最適化

**開発環境:**
- ✅ **採用済み**: Azure Automationで時間ベーススケーリング
  - 平日9:00-18:00: 最小レプリカ1（即座に応答、コールドスタートなし）
  - 夜間・週末: 最小レプリカ0（完全停止、コスト0）
  - Automationコスト: 無料枠内（¥0）
  - コスト削減効果: **¥5,464/月（-45%）**
- Container Registry不使用時は削除（¥750/月削減）

**本番環境:**
- 最小レプリカ2-3で高可用性確保
- CPU/メモリの実使用量を監視し、適切なサイズに調整
- オートスケール設定の最適化

### 3. データベースの最適化

**開発環境:**
- Burstable tierの活用
- ストレージサイズの見直し（初期は32GBで十分）

**本番環境:**
- Reserved Capacity（1年/3年契約）で最大65%割引
- 読み取りレプリカは必要な場合のみ追加

### 4. ストレージの最適化

- ライフサイクル管理で古いデータをCoolまたはArchive層に移動
- 不要なデータの定期削除
- LRSで十分な環境はZRSを使用しない

### 5. 監視・ログの最適化

- Log Analyticsのデータ保持期間を30日に短縮（デフォルト90日）
- 不要なログの収集を停止
- サンプリング機能の活用

### 6. 予約インスタンスの活用

**1年予約:**
- PostgreSQL Flexible Server: 約38%割引
- Redis: 約20-30%割引

**3年予約:**
- PostgreSQL Flexible Server: 約55%割引
- Redis: 約40-50%割引

---

## コスト比較: リージョン別

| リソース | 東日本 | 米国東部 | 差分 |
|---------|-------|---------|------|
| Application Gateway WAF_v2 | 基準 | -15% | 約¥3,000/月削減 |
| Container Apps | 基準 | -10% | 約¥1,200/月削減 |
| PostgreSQL | 基準 | -20% | 約¥600/月削減（開発） |
| Redis | 基準 | -15% | 約¥420/月削減（開発） |

**注**: 東日本リージョンは他リージョンと比較してやや高額ですが、レイテンシーとデータ主権の観点から日本国内での運用が推奨されます。

---

## まとめ

### コストレンジ

| 環境 | 構成 | 月額コスト | 主な特徴 |
|-----|-----|----------|---------|
| **開発環境** | 時間ベーススケーリング | ¥33,114/月（Registry除く）<br>¥33,864/月（Registry含む） | Standard_v2 + 平日9-18時稼働 |
| **本番環境（最小）** | WAF_v2、HA構成 | ¥218,000/月 | 基本HA構成 |
| **本番環境（標準）** | 中負荷想定 | ¥280,000/月 | 推奨構成 |
| **本番環境（高負荷）** | スケールアウト | ¥400,000/月 | 高トラフィック対応 |

**開発環境コスト削減実績**:
- Application Gateway: WAF_v2 → Standard_v2で**¥7,890/月削減（-37%）**
- Container Apps: 時間ベーススケーリングで**¥5,464/月削減（-45%）**
- **合計削減額: ¥13,354/月（-28%削減）**
- **年間削減額: ¥160,248**
- **最終月額: ¥33,864（Container Registry含む）/ ¥33,114（Registry除く）**
- **参考コスト（WAF_v2 + 12時間稼働）**: ¥47,218/月

### 主要コストドライバー

#### 開発環境（時間ベーススケーリング構成）
1. **Application Gateway** (40%): ロードバランサー、SSL終端（WAFなし）
2. **Container Apps** (20%): 平日9時間のみ稼働
3. **Private Endpoint & Network** (15%): プライベート接続
4. **PostgreSQL** (9%): Burstable tier
5. **Redis** (8%): Basic tier
6. **監視・ログ** (4%): ログ量とデータ保持期間

#### 本番環境（WAF_v2）
1. **Application Gateway** (35%): WAF機能とデータ処理量
2. **Container Apps** (25%): レプリカ数とリソース割り当て
3. **PostgreSQL** (20%): HA構成とストレージサイズ
4. **監視・ログ** (17%): ログ量とデータ保持期間

### 推奨アプローチ

**開発環境構成**:
- **Application Gateway**: Standard_v2でコスト最適化（WAF機能なし）
- **Container Apps**: Azure Automationで時間ベーススケーリング
  - 平日9:00-18:00: 最小レプリカ1（即座に応答）
  - 夜間・週末: 最小レプリカ0（コスト0）
  - Automationコスト: 無料枠内
- **セキュリティ**: NSGとPrivate Endpointで基本セキュリティ確保
- **データベース**: Burstable B1ms tier
- **Redis**: Basic C1 tier
- **月額: ¥33,114（Registry除く）/ ¥33,864（Registry含む）**

**本番環境構成**:
- **Application Gateway**: WAF_v2で高セキュリティ（OWASP攻撃防御）
- **Container Apps**: 最小レプリカ2+で高可用性
- **データベース**: General Purpose tier + Zone-Redundant HA
- **Redis**: Standard tier（レプリケーション有効）
- **Reserved Capacity活用**: 長期契約割引（検討）
- **月額: ¥218,000-¥280,000**

**段階的スケール**: 小規模から開始し、実使用量に基づいてスケールアップ

---

## 次のステップ

1. Azure料金計算ツールで正確な見積もりを作成
2. 無料枠（12ヶ月）の活用を検討
3. Reserved CapacityまたはAzure Savingsプランの適用
4. コスト管理アラートの設定（月額予算超過時の通知）

**参考リンク:**
- [Azure料金計算ツール](https://azure.microsoft.com/ja-jp/pricing/calculator/)
- [Azure料金ページ](https://azure.microsoft.com/ja-jp/pricing/)
- [コスト管理とBilling](https://learn.microsoft.com/ja-jp/azure/cost-management-billing/)
